
pipeline {
    agent any

    stages {
        stage('Build') {
            agent any
            steps {
                sh 'docker build -f Dockerfile -t website:latest .'

            }
        }

        stage('Test') {
            steps {
                sh 'npm install --save express'
                sh 'npm install --save-dev jest'
                sh 'npm install --save-dev supertest'
                sh 'npm run test'
            }
        }

        stage('Deploy') {
            steps {
                sh 'docker run -d -it --rm -p 3000:3000 --name my_website website:latest'
            }
        }

        stage('Code Quality Check via SonarQube') {
           steps {
               script {
               def scannerHome = tool 'sonar-scanner';
                   withSonarQubeEnv("sonarqube-container") {
                   sh "${tool("sonarqube")}/bin/sonar-scanner \
                   -Dsonar.projectKey=test-node-js \
                   -Dsonar.sources=. \
                   -Dsonar.css.node=. \
                   -Dsonar.host.url=http://localhost:9000 \
                   -Dsonar.login=squ_fd564eb5bf921192afb8496e635c5459f54ba6b7"
                       }
                   }
               }
           }
    }
}